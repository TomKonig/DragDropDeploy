---
title: Database & Migrations
---

## Database & Migrations

Covers schema structure, migration workflow, and role strategy.

### Tech Stack

- PostgreSQL 16
- Prisma ORM (schema-driven migrations)

### Core Concepts

| Concept | Notes |
|---------|-------|
| Prisma schema | Located at `backend/prisma/schema.prisma` |
| Migrations | Generated into `backend/prisma/migrations/<timestamp>_<name>` |
| Seed data | (Not yet implemented) |
| Roles | Planned separation: migrator, app_rw, app_ro |

### Migration Workflow

1. Edit `schema.prisma`
2. Dev migration: `npm run prisma:migrate:dev -w backend -- --name <change>`
3. Commit generated migration folder
4. Deploy: `npm run prisma:migrate:deploy -w backend` (CI/production)
5. Avoid destructive changes; prefer additive then follow-up cleanup in major release

### Rollback Strategy

- Favor forward-only migrations
- If emergency: restore from pre-deploy backup (see rollback doc)
- Down migrations not generated by default (Prisma) â€” manual SQL if absolutely required

### Role Separation (Planned)

Script `backend/prisma/db_roles.sql` to create:

| Role | Purpose |
|------|---------|
| ddd_migrator | Owns schema, runs migrations |
| ddd_app_rw | Runtime writes & reads |
| ddd_app_ro | Read-only queries / reporting |

Runtime app uses `ddd_app_rw`; migrations executed with `ddd_migrator` via separate connection string.

### Future: Row Level Security

- Enable RLS when multi-tenant boundaries needed
- Add policies: owners can access their own projects/deployments
- Use `SET app.user_id` session variable (or similar) for policy context

### Referential Integrity

- Use `ON DELETE CASCADE` judiciously; prefer explicit service-layer cascades for critical entities
- Keep migration diffs small for easier review

### Observability

- Track migration application time (log wrapper) in future
- Optional table `migration_audit` to record who/when applied migrations

### Performance Considerations

- Add indexes for frequently filtered columns (deployment status, project foreign keys)
- Periodic `VACUUM ANALYZE` (Postgres autovacuum usually sufficient)
- Monitor slow queries (pg_stat_statements) once enabled

### Open Questions

- Automated drift detection in CI
- Partial tenant sharding strategy (long-term scaling)
- Multi-region replication requirements
