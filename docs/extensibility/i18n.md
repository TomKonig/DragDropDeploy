---
title: Internationalization (i18n)
---

## Internationalization (i18n)

This codebase centralizes user/admin facing text in YAML locale files under `locales/<lang>/*.yml`.

### Source of Truth

All translation keys originate from the YAML files (currently only `en`). Each file can have nested structures; during build they are merged and flattened to dot-delimited keys.

Directory:

```text
locales/
	en/
		common.yml
		auth.yml
		projects.yml
		admin.yml
		errors.yml
```

### Build Pipeline

The script `npm run generate:locales` (root) flattens and emits TypeScript modules into `shared/src/locales/` plus an index map. This runs automatically before `npm run build` due to the updated root build script.

### Runtime Usage

Backend:

```ts
import { i18n } from './i18n/i18n.service';
const msg = i18n.t('auth.login.title');
```

Frontend:

```ts
import { t, setLocale } from '@dragdropdeploy/shared';
console.log(t('auth.login.title'));
setLocale('en'); // Switch active locale (if another exists)
```

Plugins:

```ts
export const examplePlugin = {
	name: 'example',
	async onUserCreated(ctx, user) {
		console.log(ctx.t('projects.list.title'));
	}
};
```

### Adding a New Locale

1. Copy `locales/en` to `locales/<newLocale>`.
2. Translate values; keep key structure identical.
3. Run `npm run check:locales -w backend` to ensure key parity.
4. Run `npm run generate:locales` and rebuild.

### Interpolation

Use `{{variable}}` placeholders in YAML strings.

```yaml
auth:
	login:
		oauth_with: "Sign in with {{provider}}"
```

Invoke:

```ts
t('auth.login.oauth_with', { provider: 'GitHub' });
```

### Key Retrieval Strategy

- Dot path lookups; missing keys return the key string itself.
- Avoid runtime concatenation of segments where possible; use explicit keys for clarity.

### Validation

`backend/scripts/check-locales.cjs` ensures all locale key sets match the default (`en`). CI should run it to prevent drift.

### Future Enhancements

- Async locale chunk loading on frontend
- ICU message format support
- Crowdin / Weblate integration script
- Type generation for strong-typed keys (union of all keys)

Minimal but extensible: this foundation aims to make translation contributions straightforward early in the project lifecycle.

### Typed Key Union (Implemented)

The build step generates `shared/src/locales/i18n-keys.ts`:

```ts
export const I18N_KEYS = [ 'auth.login.title', /* ... */ ] as const;
export type I18nKey = typeof I18N_KEYS[number];
```

Use in code:

```ts
import { t, type I18nKey } from '@dragdropdeploy/shared';
function label(key: I18nKey) { return t(key); }
// label('projects.lsit.title'); // TS error (typo)
```

Benefits: autocomplete, compile-time safety, safer plugin APIs, easier refactors.

### ICU Message Formatting

Messages now support ICU syntax via `intl-messageformat`.

Examples in YAML:

```yaml
deployments:
	summary: "{count, plural, =0 {No deployments yet} one {# deployment} other {# deployments}}"
	eta: "Estimated time: {minutes, number} {minutes, plural, one {minute} other {minutes}}"
	finished_at: "Finished at {ts, date, medium}"
```

Usage:

```ts
t('deployments.summary', { count: 5 });
t('deployments.eta', { minutes: 1 });
t('deployments.finished_at', { ts: Date.now() });
```

Fallback Behavior: If a string fails to compile or format, the raw message string is returned.

### Adding ICU Messages Safely

1. Start with a simple literal.
2. Add plural/select segments incrementally.
3. Provide all variables used (compiler errors otherwise).
4. Run `generate:locales` and build to catch issues early.

### Key Hygiene

- Avoid dynamic string concatenation for keys; rely on defined union for discoverability.
- Remove stale keys when features are removed; run a future unused-key scan script (planned).

### Usage & Drift Analysis

Command:

```bash
npm run i18n:analyze
```

Outputs:

- Undefined keys: referenced in code but missing from YAML (fails with exit code 1).
- Unused keys: present in YAML but not referenced (informational, exit 0 unless undefined present).

CI Recommendation:

1. Run `npm run generate:locales`.
2. Run `npm run i18n:analyze`.
3. Fail pipeline if undefined keys detected.

Rationale: Prevents silent fallback-to-key regressions and keeps locale files lean.
